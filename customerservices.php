<?php
// Get user_id from session
session_start();
// Check if user is logged in, if not redirect to login page
if (!isset($_SESSION['username'])) {
    header("Location: login.php");
    exit();
}
include "customerheader.php";
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Make an appointment</title>
<!-- Datepicker CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datepicker/dist/datepicker.min.css">
<style>
/* Your CSS styles */
/* Center align container and add space */
.container {
    text-align: center;
    margin-top: 20px;
}

/* Center align form */
#service-form {
    display: inline-block;
    text-align: left;
}

/* Add space between form and services */
.service-container {
    margin-bottom: 20px;
}

/* Center align select date and time labels and buttons */
.date-container, .submit-container {
    margin-top: 20px;
}

 body {
            margin: 200px;  
}

        /* Styling for the date selection */
        .date-container {
            text-align: center;
        }

        .date-container label {
            font-weight: bold;
        }

        .date-container select {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            outline: none;
            transition: border-color 0.3s ease-in-out;
        }

        .date-container select:hover,
        .date-container select:focus {
            border-color: #ff4081;
        }

        /* Rest of the CSS styles... */

        .submit-container {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 40px;
        }


</style>

</head>
<body>
<div class="container">
    <div class="services-container">
        <div class="inner-container">
            <h1 class="section-title">Services</h1>
            <div class="border"></div>
            <form id="service-form" method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>">
                <div class="service-container">
<?php
    require('db.php');
    // Database connection
    $conn = mysqli_connect($servername, $dbusername, $dbpassword, $dbname);

// Check connection
if ($conn->connect_error) {
die("Connection failed: " . $conn->connect_error);
}
// Fetch services data from the database
$sql = "SELECT * FROM services";
$result = $conn->query($sql);
if ($result->num_rows > 0) {
// Output data of each row
while ($row = $result->fetch_assoc()) {
echo '<div class="service-box">';
echo '<div class="service-icon">';
echo '<img src="' . htmlspecialchars($row["image"]) . '" alt="' . htmlspecialchars($row["Name"]) . '">';
echo '</div>';
echo '<div class="service-title">';
echo '<input type="checkbox" id="' . htmlspecialchars($row["Name"]) . '" name="service[]" value="' . htmlspecialchars($row["Name"]) . '">';
echo '<label for="' . htmlspecialchars($row["Name"]) . '"><b>' .' '. htmlspecialchars($row["Name"]) . '</b></label>';
echo '</div>';
echo '<div class="description">' . htmlspecialchars($row["Description"]) . '<br> Price: $' . htmlspecialchars($row["price"]) . '</div>';
echo '</div>';
}
} else {
echo "0 results";
}
$conn->close();
?>
</div>
<!-- Date list for the next 7 days -->
<div class="date-container">
<label for="appointment-date">Select Appointment Date:</label>
<select id="appointment-date" name="appointment-date" required>
<?php
// Get current date
$currentDate = date('Y-m-d');
// Loop for the next 7 days
for ($i = 0; $i < 7; $i++) {
$date = date('Y-m-d', strtotime("+$i days", strtotime($currentDate)));
echo "<option value='" . htmlspecialchars($date) . "'>" . htmlspecialchars($date) . "</option>";
}
?>
</select>
</div>

<!-- Time selection for all services -->
<div class="date-container">
<label for="selected_time">Select Appointment Time:</label>
<select name="selected_time" id="selected_time" required>
<option value="Morning">Morning (9:00 AM to 12:00 PM)</option>
<option value="Evening">Evening (4:00 PM to 9:00 PM)</option>
</select>
</div>


<!-- Submit button -->
<div class="submit-container">
<button type="submit" class="btn" name="submit">Continue</button>
</div>
</form>
</div>
</div>

<?php
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Check if submit button is clicked
    if (isset($_POST['submit'])) {
        // Check if at least one service is selected
        if (isset($_POST['service'])) {
             require('db.php');
            // Database connection
            $conn = mysqli_connect($servername, $dbusername, $dbpassword, $dbname);

            // Check connection
            if ($conn->connect_error) {
                die("Connection failed: " . $conn->connect_error);
            }

            $user_id = $_SESSION['user_id'];
            // Get selected date and time slot
            $date = $_POST['appointment-date'];
            $timeSlot = $_POST['selected_time'];

            // Calculate time slot abbreviation
            $timeAbbreviation = ($timeSlot == "Morning") ? "M" : "E";

            // Check the number of appointments for the selected date and time slot
            $sql = "SELECT COUNT(*) AS totalAppointments FROM appointments WHERE date = ? AND time = ?";
            $stmt = $conn->prepare($sql);
            $stmt->bind_param("ss", $date, $timeAbbreviation);
            $stmt->execute();
            $result = $stmt->get_result();
            $row = $result->fetch_assoc();
            $totalAppointments = $row['totalAppointments'];

            // Check if the total number of appointments is less than 14
            if ($totalAppointments < 3) {
                // Concatenate selected services into a single string
                $selectedServices = implode(", ", $_POST['service']);

                // Insert the appointment into the database
                $sql = "INSERT INTO appointments (service_name, date, time, customer_id) VALUES (?, ?, ?, ?)";
                $stmt = $conn->prepare($sql);
                $stmt->bind_param("sssi", $selectedServices, $date, $timeAbbreviation, $user_id);
                if ($stmt->execute()) {
                    // Appointment added successfully
                    echo "<script>alert('Appointment booked successfully for the selected date and time slot.'); window.location.href = 'customer-home.php';</script>";
                } else {
                    echo "Error: " . $sql . "<br>" . $conn->error;
                }
            } else {
                // Appointment limit reached for the selected time slot
                echo "<script>alert('Appointment limit reached for the selected time slot. Please choose another time slot.');</script>";
            }

            $conn->close();
        } else {
            // No service selected
            echo "<script>alert('Please select at least one service.');</script>";
        }
    }
}
?>


