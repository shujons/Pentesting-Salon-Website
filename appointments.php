<?php
include "customerheader.php";
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Appointments</title>
    <style>
        /* Your existing CSS styles */
        * {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        body {
            margin: 250px;
            font-family: "Lato", Helvetica, Arial, sans-serif;
            font-size: 16px;
            background-color: #fee3ec;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #ffd1dc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #efa6baa6;
            color: #fff;
            text-transform: uppercase;
        }

        td {
            background-color: #fff0f5;
        }

        button {
            padding: 5px 10px;
            cursor: pointer;
            background-color: #efa6baa6;
            color: #fff;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease-in-out;
            margin-right: 10px;
        }

        button:hover {
            background-color: #d81b60;
        }

#updateForm {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px; /* Add space at the top */
}

#updateAppointmentForm {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#selected_date,
#selected_time {
    margin-bottom: 10px;
}

label {
    margin-bottom: 5px;
}


    </style>


</head>
<body>

<table>
    <thead>
    <tr>
        <th>Appointment ID</th>
        <th>Service Name</th>
        <th>Date</th>
        <th>Time</th>
        <th>Any modification?</th>
    </tr>
    </thead>
    <tbody id="appointmentsTable">
<?php
    // Start session
    session_start();
    
    require('db.php');
    // Database connection
    $conn = mysqli_connect($servername, $dbusername, $dbpassword, $dbname);

    // Check connection
    if ($conn->connect_error) {
        die("Connection failed: " . $conn->connect_error);
    }

    // Check if customer ID is set in session
    if(isset($_SESSION['user_id'])) {
        $customer_id = $_SESSION['user_id'];

        // Fetch appointments for the current customer from database
        $sql = "SELECT * FROM appointments WHERE customer_id = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("i", $customer_id);
        $stmt->execute();
        $result = $stmt->get_result();

        if ($result->num_rows > 0) {
            // Output data of each row
            while($row = $result->fetch_assoc()) {
                echo "<tr>";
                echo "<td>" . htmlspecialchars($row["ID"]) . "</td>";
                echo "<td>" . htmlspecialchars($row["service_name"]) . "</td>";
                echo "<td>" . htmlspecialchars($row["date"]) . "</td>";
                echo "<td>" . htmlspecialchars($row["time"]) . "</td>";
                echo "<td>";
                echo "<button onclick='showUpdateForm(" . htmlspecialchars($row["ID"]) . ")'>Update</button>";
                echo "<button onclick='deleteAppointment(" . htmlspecialchars($row["ID"]) . ")'>Delete</button>";
                echo "</td>";
                echo "</tr>";
            }
        } else {
            echo "<tr><td colspan='4'>0 results</td></tr>";
        }
    } else {
         header("Location: login.php");
         exit();

    }

    $stmt->close();
    $conn->close();
?>

    </tbody>
</table>


<div id="updateForm" style="display: none;">
    <form id="updateAppointmentForm" onsubmit="return validateForm()"> <!-- Add a form with an ID for submission -->
        <select id="selected_date" required>
            <?php
            // Get current date
            $currentDate = date('Y-m-d');
            // Loop for the next 7 days
            for ($i = 0; $i < 7; $i++) {
                $date = date('Y-m-d', strtotime("+$i days", strtotime($currentDate)));
                echo "<option value='" . htmlspecialchars($date) . "'>" . htmlspecialchars($date) . "</option>";
            }
            ?>
        </select>

        <select id="selected_time" required>
            <option value="Morning">Morning (9:00 AM to 12:00 PM)</option>
            <option value="Evening">Evening (4:00 PM to 9:00 PM)</option>
        </select>

        <!-- Invoke updateAppointment() when the button is clicked -->
        <button type="button" onclick="confirmUpdate()">Confirm Update</button>
    </form>
</div>

<script>
    var appointmentIdToUpdate; // Variable to store the appointment ID for updating

    // Function to show the update form
    function showUpdateForm(appointmentId) {
        appointmentIdToUpdate = appointmentId; // Store the appointment ID
        document.getElementById('updateForm').style.display = 'block';
        // Scroll to the update form
        document.getElementById('updateForm').scrollIntoView({ behavior: 'smooth' });
    }

    // Client-side input validation
    function validateForm() {
        var selectedDate = document.getElementById('selected_date').value;
        var selectedTime = document.getElementById('selected_time').value;

        // Validate date and time inputs
        if (!selectedDate || !selectedTime) {
            alert('Please select date and time');
            return false;
        }

        return true;
    }

    // Function to handle confirming the update
    function confirmUpdate() {
        if (validateForm()) {
            var selectedDate = document.getElementById('selected_date').value;
            var selectedTime = document.getElementById('selected_time').value;

            // AJAX request
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "update_appointment.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        // Display response from the server
                        var response = xhr.responseText;
                        alert(response);
                        // Redirect after successful update
                        if (response.includes("successfully")) {
                            window.location.href = 'customer-home.php';
                        }
                    } else {
                        alert("Error: Unable to update appointment. Please try again later.");
                    }
                }
            };
            xhr.send("selectedDate=" + selectedDate + "&selectedTime=" + selectedTime + "&appointmentIdToUpdate=" + appointmentIdToUpdate);
        }
    }

    // Function to delete appointment
    function deleteAppointment(appointmentId) {
        if (confirm("Are you sure you want to delete this appointment?")) {
            // Send appointment ID to PHP script for deletion
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "delete_appointment.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    location.reload(); // Reload the page after deletion
                }
            };
            xhr.send("id=" + appointmentId);
        }
    }
</script>

</body>
</html>

