<?php
require('db.php');
// Database connection
$conn = mysqli_connect($servername, $dbusername, $dbpassword, $dbname);

// Check connection
if ($conn->connect_error) {
   die("Connection failed: " . $conn->connect_error);
}

// Retrieve data sent by the client-side JavaScript
$selectedDate = $_POST['selectedDate'];
$selectedTime = $_POST['selectedTime'];
$appointmentIdToUpdate = $_POST['appointmentIdToUpdate'];

// Calculate time slot abbreviation
$timeAbbreviation = ($selectedTime == "Morning") ? "M" : "E";

// Prepare the SQL statement with placeholders
$sql = "SELECT COUNT(*) AS totalAppointments FROM appointments WHERE date = ? AND time = ?";
$stmt = $conn->prepare($sql);

// Bind parameters to the placeholders
$stmt->bind_param("ss", $selectedDate, $timeAbbreviation);

// Execute the prepared statement
$stmt->execute();

// Get the result
$result = $stmt->get_result();
$row = $result->fetch_assoc();
$totalAppointments = $row['totalAppointments'];

// Check if the total number of appointments is less than 14
if ($totalAppointments < 3) {
    // Update the appointment into the database
    $sql = "UPDATE appointments SET date = ?, time = ? WHERE ID = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("ssi", $selectedDate, $timeAbbreviation, $appointmentIdToUpdate);
    if ($stmt->execute()) {
        // Appointment updated successfully
        echo "Appointment updated successfully with the selected date and time slot.";
    } else {
        echo "Error: " . $sql . "<br>" . $conn->error;
    }
} else {
    // Appointment limit reached for the selected time slot
    echo "Appointments limit reached for the selected time slot. Please choose another time slot.";
}

// Close the connection
$conn->close();
?>

